<!--
  Copyright (C) 2026 Bernardo Gómez Bey
  SPDX-License-Identifier: AGPL-3.0-or-later
-->

{% extends "base.html" %}
{% block content %}


<!-- index.html -->
<div class="card">
  <h2 class="title">Registro SAR</h2>
  <p class="subtitle">Selecciona un Excel y regenera la vista operativa (VIEW_Full) y la lista de incoherencias (ISSUES).</p>

  {% if last_error %}
    <div class="errorbox">
      <b>Error:</b> {{ last_error }}
    </div>
    <br>
  {% endif %}

  <div class="help">
    <b>Tip:</b> si hay huérfanos, no entran en <span class="muted">VIEW_Full</span> por política; se reportan en <span class="muted">ISSUES</span>.
  </div>

  <br>

  <form method="post" action="/regenerate" enctype="multipart/form-data">
    <div class="row">
      <div class="field" style="flex:1; min-width:320px;">
        <label>Seleccionar registry.xlsx (recomendado)</label>
        <input type="file" name="file" accept=".xlsx">
      </div>

      <div class="field" style="flex:1; min-width:320px;">
        <label>O usar ruta manual (opcional)</label>
        <input name="path" value="{{path}}" placeholder="C:\ruta\registry.xlsx">
      </div>

      <button class="btn btn-primary" type="submit">Regenerate</button>
    </div>
  </form>
  {% if last_data_registry %}
    <div class="row" style="margin-top:10px; align-items:center;">
      <div class="muted" style="flex:1;">
        Último registry encontrado en <span class="mono">/data</span>: <span class="mono">{{ last_data_registry }}</span>
      </div>
      <a class="btn btn-secondary" href="/open-last">Abrir último</a>
    </div>
  {% else %}
    <div class="row" style="margin-top:10px; align-items:center;">
      <div class="muted" style="flex:1;">
        No se ha encontrado ningún <span class="mono">.xlsx</span> en <span class="mono">/data</span>.
      </div>
      <a class="btn btn-secondary" href="/open-last">Abrir último</a>
    </div>
  {% endif %}


  {% if last_regen %}
    <p class="muted" style="margin-top:10px;">Última regeneración: <b>{{ last_regen }}</b></p>
  {% endif %}
</div>

<br>

<div class="card">
  <h3 class="title" style="font-size:16px;">Plantilla base</h3>
  {% if schema and schema.template_exists %}
    <div class="muted" style="font-weight:900;">Plantilla: <span class="mono">{{ schema.template_path }}</span></div>
    <div class="row" style="margin-top:8px; gap:16px; align-items:flex-start; flex-wrap:wrap;">
      <div style="min-width:260px;">
        <div class="muted">schema_version (plantilla)</div>
        <div class="mono" style="font-weight:900;">{{ schema.template_schema_version or '-' }}</div>
      </div>
      <div style="min-width:260px;">
        <div class="muted">schema_version (registry)</div>
        <div class="mono" style="font-weight:900;">{{ schema.registry_schema_version or '-' }}</div>
      </div>
    </div>

    {% if schema.status == 'dirty' %}
      <div class="warnbox" style="margin-top:12px;">
        <b>Plantilla y registry no coinciden.</b>
        {% if schema.added %}
          <div class="muted" style="margin-top:6px;">Campos nuevos en el registry (no están en la plantilla):</div>
          <ul style="margin:6px 0 0 18px;">
            {% for sh, cols in schema.added.items() %}
              <li><span class="mono">{{ sh }}</span>: <span class="mono">{{ cols|join(', ') }}</span></li>
            {% endfor %}
          </ul>
        {% endif %}
        {% if schema.missing %}
          <div class="muted" style="margin-top:10px;">Campos que existen en la plantilla pero faltan en el registry:</div>
          <ul style="margin:6px 0 0 18px;">
            {% for sh, cols in schema.missing.items() %}
              <li><span class="mono">{{ sh }}</span>: <span class="mono">{{ cols|join(', ') }}</span></li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    {% else %}
      <div class="help" style="margin-top:12px;">Plantilla y registry están alineados.</div>
    {% endif %}

    <div class="row" style="margin-top:12px; gap:10px; flex-wrap:wrap;">
      <form method="post" action="/registry/reset-from-template">
        <button class="btn btn-secondary" type="submit">Crear registry desde plantilla</button>
      </form>
      <form method="post" action="/template/promote">
        <button class="btn btn-primary" type="submit" {% if not schema.added %}disabled{% endif %}>
          Promover campos del registry a plantilla
        </button>
      </form>
      <form method="post" action="/template/migrate-registry">
        <button class="btn btn-ghost" type="submit" {% if not schema.missing %}disabled{% endif %}>
          Migrar registry (añadir columnas faltantes)
        </button>
      </form>
    </div>

  {% else %}
    <div class="errorbox">
      <b>No se ha encontrado plantilla base.</b>
      Coloca un <span class="mono">registry_template.xlsx</span> en <span class="mono">/data</span> o define <span class="mono">SAR_TEMPLATE_PATH</span>.
    </div>
  {% endif %}
</div>

{% if has_data %}
  <br>

  <div class="grid grid-3">
    <div class="kpi">
      <div style="display:flex; justify-content:space-between; gap:12px; align-items:baseline;">
        <div class="muted" style="font-weight:900;">Runtimes en VIEW_Full</div>
        <div style="font-size:18px; font-weight:900;">{{ view_rows }}</div>
      </div>
    </div>

    <div class="kpi">
      <div style="display:flex; justify-content:space-between; gap:12px; align-items:baseline;">
        <div class="muted" style="font-weight:900;">Issues (error)</div>
        <div style="font-size:18px; font-weight:900;">{{ issues_errors }}</div>
      </div>
    </div>

    <div class="kpi">
      <div style="display:flex; justify-content:space-between; gap:12px; align-items:baseline;">
        <div class="muted" style="font-weight:900;">Issues (warning)</div>
        <div style="font-size:18px; font-weight:900;">{{ issues_warnings }}</div>
      </div>
    </div>
  </div>

  <br>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="muted">Archivo activo</div>
        <div style="font-family:var(--mono); font-size:12px;">{{ path }}</div>
      </div>
      <div class="row">
        <a class="btn btn-primary" href="/create/C1">Crear C1 (Project)</a>
        <a class="btn btn-ghost" href="/level/C1">Ver C1</a>
        <a class="btn btn-ghost" href="/level/C2">Ver C2</a>
        <a class="btn btn-ghost" href="/level/C3">Ver C3</a>
        <a class="btn btn-ghost" href="/level/C4">Ver C4</a>
        <a class="btn btn-secondary" href="/view-full">Abrir Full View</a>
        <a class="btn btn-secondary" href="/issues">Abrir Issues</a>
      </div>
    </div>
  </div>
{% endif %}

{% endblock %}
